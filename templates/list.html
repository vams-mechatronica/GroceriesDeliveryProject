{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- title -->
  <title>Product List</title>
  <meta name="description" content="" />
  <meta name="keywords" content="" />
  <meta name="author" content="">
  <!-- favicon -->
  <link rel="shortcut icon" type="image/favicon" href="{% static 'image/fevicon.png' %}">
  <!-- bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.1/font/bootstrap-icons.css">
  <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap.min.css' %}">
  <!-- simple-line icon -->
  <link rel="stylesheet" type="text/css" href="{% static 'css/simple-line-icons.css' %}">
  <!-- font-awesome icon -->
  <link rel="stylesheet" type="text/css" href="{% static 'css/font-awesome.min.css' %}">
  <!-- themify icon -->
  <link rel="stylesheet" type="text/css" href="{% static 'css/themify-icons.css' %}">
  <!-- ion icon -->
  <link rel="stylesheet" type="text/css" href="{% static 'css/ionicons.min.css' %}">
  <!-- owl slider -->
  <link rel="stylesheet" type="text/css" href="{% static 'css/owl.carousel.min.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'css/owl.theme.default.min.css' %}">
  <!-- swiper -->
  <link rel="stylesheet" type="text/css" href="{% static 'css/swiper.min.css' %}">
  <!-- animation -->
  <link rel="stylesheet" type="text/css" href="{% static 'css/animate.css' %}">
  <!-- style -->
  <link rel="stylesheet" type="text/css" href="{% static 'css/custome.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'css/responsive.css' %}">
  <link rel="stylesheet" href="{% static 'assets/css/bootstrap.css' %}">
  <link rel="stylesheet" href="{% static 'css/searchpop.css' %}">
  <link rel="stylesheet" href="{% static 'css/login.css' %}">


</head>

<body class="home-1">
  <!-- product header start -->
  <div class="about-breadcrumb">
    <div class="about-back section-tb-padding" >
      <div class="container">
        <div class="row">
          <div class="col">
            <div class="list-page-header">
              <h1>{{category.category_name}}</h1>
              <div class="position-relative">
                <i class="bi bi-search serach_icons-list"></i>
                {% comment %}
                <!-- {% url 'productsearchcategory' category.category_id %} -->
                {% endcomment %}
                <form class="w-100 me-3" role="search" name="search-products" method="GET" action="">
                  <input type="text" name="search" id="search" onkeyup="showProducts(this.value)" placeholder="What can we get you?"></form>
                  <div class="suggestProduct" style="display: none;"></div> 
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <style>
    .about-back{
      background-image: url(/static/img/list-page-1.jpg);
      height: 35vh;
  }
  .product_grid{
    width: unset;
    width: 100%;
    margin: 0;
  }.prod_list-page {
    margin-top: 170px;
}.list-page-header {
  max-width: 450px;
  top: 130px;
}
    @media(max-width:500px){
      .prod_list-page {
        margin-top: 120px;
    }
    .prod_list-page {
      margin-top: 120px;
  }
  .list-page-header {
    max-width: 300px;
    top: 110px;
  }
    .about-back{
        background-image: url(/static/img/list-page-1.jpg);
        height: 25vh;
    }
    }
  </style>
  <!-- login popup start here  -->
  <div class="login-sign-popup" id="login">
    <div class="login col-xl-6 col-lg-6 col-md-6 col-12">
      <div class="head-login">
        <h3 class="text-center content">Phone Number Verification</h3>
        <h3 class="times" onclick="hidePopLogin()">&times;</h3>
      </div>
      <div class="login-body">
        <p id="hide-num-text" >Enter your phone number to
          Login/Sign up</p>
        <p id="hide-otp-text" style="display: none;">Enter the OTP</p>
        <!-- <form action="" method="post"> -->
          <div class="default-box">
            <div class="phone-box col-xl-6 col-lg-6 col-md-6 col-12">
              <div class="phone-icon" id="hide-91">+91</div>
              <input type="tel" class="inputfilter" allow="[0-9]" onkeyup="showGreenButton('button_submit',this,10)" 
                maxlength="10" minlength="10" name="mobile" id="mobile" placeholder="Enter Number">
              <input type="tel" class="inputfilter" style="display: none;" allow="[0-9]" onkeyup="showGreenButton('button_otp',this,6)"
                maxlength="6" minlength="6" name="otp" id="otp" placeholder="Please Enter OTP: 123456">
            </div>
          </div>
          <p class="error-loction" id="error_login"></p>
          <div class="default-box">
            <button onclick="get_otp('mobile')" class="col-xl-6 col-lg-6 col-md-6 col-12" id="button_submit" disabled>Next</button>
            <button onclick="verify_otp('otp')" style="display: none;" class="col-xl-6 col-lg-6 col-md-6 col-12" id="button_otp" disabled>Enter OTP</button>
          </div>
        <!-- </form> -->
        <p class="bellow-para">By continuing, you agree to our</p>
        <p class="extra-links"><a href="#">Terms of service</a> <a href="#">Privacy policy</a></p>
      </div>
    </div>
  </div>
  <!-- login popup end here  -->
  <!-- product header end -->
  <!-- product list start -->
  <div class="prod_list-page">
    <div class="container">
      <div class="row ">
        <div class="col-12  d-flex flex-wrap justify-content-center p-0">
        {% for categorypro in catproducts %}
        <div class="col-6 col-md-6 col-xl-2 col-lg-2 p-1">
          <div class=" product_grid mb-4 .mb-md-0">
            <div class="product_img"><img src=http://ashekhar.pythonanywhere.com/media/{{categorypro.products.prod_mainimage}} alt="" onclick="window.location.href='{% url 'productdetail' categorypro.products.product_id %}'"></div>
            <div class="product_name">
              <p>{% if categorypro.products.product_name|length > 20 %} {{categorypro.products.product_name|slice:":40"}}{% elif categorypro.products.product_name|length > 35 %}{{categorypro.products.product_name|slice:":40"}}...{% else %}{{categorypro.products.product_name}}<br> &nbsp;{% endif %}</p>
            </div>
            <div class="product_Quantity"><span>{{categorypro.products.unit}}</span></div>
            <div class="d-flex justify-content-between">
              <div class="product_pirce"><span class="pro_mrp">₹{{categorypro.list_price}}</span>
                <span class="pro_sell">₹{{categorypro.products.max_retail_price}}</span>
              </div>
              {% if request.user.is_authenticated%}
                <a class="btn-style1 btn-padding add-to-cart b-{{categorypro.products.product_id}}" onclick="item_add('id',this)" id="{{categorypro.products.product_id}}-add_item:category"> ADD
                  </a>
              {% else %}
                <a class="btn-style1 btn-padding add-to-cart b-{{categorypro.products.product_id}}" onclick="showPopLogin()" id="{{categorypro.products.product_id}}-add_item:category">
                ADD
                </a>
              {% endif %}
              <div style="display:none" class="btn-style1 btn-padding" id="{{categorypro.products.product_id}}-in-dec-category">
                <span class="minus-bttn" onclick="minusBtnClick({{categorypro.products.product_id}},'category')" id="{{categorypro.products.product_id}}-decrease">-</span>&nbsp;
                <span id="{{categorypro.products.product_id}}-qunt_val-category">1</span>&nbsp;
                <span class="plus-bttn" onclick="plusBtnClick({{categorypro.products.product_id}},'category')" id="{{categorypro.products.product_id}}-increas">+</span>
              </div>
            </div>

            <div class="product_dicont"><span>Rs.{{categorypro.discount|floatformat:0}} Off</span></div>
          
          </div>
        </div>
          {% empty %}
          <tr>
              <td colspan='5'>No Matching Item</td>
          </tr>
        </div>
        {% endfor %}
        
      </div>
    </div>
  </div>
  <div class="pro-btn mt-5">


    <div class="container">
      <div class="row">
            <!-- lavitate cart view  -->
    <div class="pro-btn fix-in-area"  onclick="{% if request.user.is_authenticated %}window.location.href='{% url 'cartview' %}'{% else %} showPopLogin() {% endif %}" >
      <a class="btn-style1 d-flex justify-content-between"><div><span id="quantity">1 </span> items  | <span id="cart-amount"></span></div><div><i class="bi bi-bag"></i> View cart</div></a>
    </div>
    <!-- lavitate cart view  -->
      </div>
    </div>
  </div>





  
    <div class="mm-fullscreen-bg"></div>
  <!-- jquery -->
  <script src="{% static 'js/modernizr-2.8.3.min.js' %}"></script>
  <script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
  <!-- bootstrap -->
  <script src="{% static 'js/bootstrap.min.js' %}"></script>
  <!-- popper -->
  <script src="{% static 'js/popper.min.js' %}"></script>
  <!-- fontawesome -->
  <script src="{% static 'js/fontawesome.min.js' %}"></script>
  <!-- owl carousal -->
  <script src="{% static 'js/owl.carousel.min.js' %}"></script>
  <!-- swiper -->
  <script src="{% static 'js/swiper.min.js' %}"></script>
  <!-- custom -->
  <script src="{% static 'js/custom.js' %}"></script>
  <script src="{% static 'assets/js/bootstrap.js' %}"></script>
  <script src="{% static 'assets/js/jquery.js' %}"></script>
  <script src="{% static 'js/jquery.bootstrap.modal.forms.js' %}"></script>
  <!-- You can alternatively load the minified version -->
  <script src="{% static 'js/jquery.bootstrap.modal.forms.min.js' %}"></script>
  <script>
    var getCookie = function (name) {
      var cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
          var cookie = jQuery.trim(cookies[i]);
          // Does this cookie string begin with the name we want?
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    };
    function zoom(e) {
      var zoomer = e.currentTarget;
      e.offsetX ? offsetX = e.offsetX : offsetX = e.touches[0].pageX
      e.offsetY ? offsetY = e.offsetY : offsetX = e.touches[0].pageX
      x = offsetX / zoomer.offsetWidth * 100
      y = offsetY / zoomer.offsetHeight * 100
      zoomer.style.backgroundPosition = x + '% ' + y + '%';
    };
    function hidePopLogin() {
        $('#login').hide()
        $('body').css({ "overflow": "auto" })
      };
      function showPopLogin() {
        history.scrollRestoration = "manual";
        scrollToTop(0);
        $('#login').show()
        $('body').css({ "overflow": "hidden" })
      };
      function scrollToTop(hei) {
    window.scrollTo({top: hei,
    left: 0,
    behavior: 'smooth'});
    };
    function item_add(id_product,self){
      $(self).hide()
      var element_id = self.id.split("-")[0]
      var cate = self.id.split(":")[1]
      //console.log(element_id+"-in-dec:"+cate);
      $("#"+element_id+"-in-dec-"+cate).show();
      //document.getElementById("#"+element_id+"in-dec").style.display = "block";
      $('.fix-in-area').show()
    };
    jQuery(document).ready(function(){
      $('.plus-bttn').click(function(e){
        e.preventDefault();
        //fieldName = $(this).attr('field');
        const elementId = $(this).attr('id').split('-')[0]
        //console.log(elementId);
        domain = window.location.origin
        path_name = '/buy/api/v1/customer/order/add/' //change-this url
        $.ajax({
            type: 'POST',
            url: domain+path_name,
            data: {
                "csrfmiddlewaretoken":g_csrftoken,
                "product" : elementId.toString(),
                "quantity": "1"
            },
            success: function(response) {
                if (response){
                  //console.log(response['cart']['items'][0]['quantity']);
                  document.getElementById("cart-amount").innerHTML = "₹"+response['amount'];
                  document.getElementById("quantity").innerHTML = response['qty'];
                  document.getElementById(elementId+"-qunt_val-category").innerHTML = response['item_qty'];
                  //$("#"+element_id+"-qunt_val").append(response['cart']['items']['quantity'])
                  }
                }
              })
            });
      $('.add-to-cart').click(function(e){
        e.preventDefault();
        //fieldName = $(this).attr('field');
        const elementId = $(this).attr('id').split('-')[0]
        //console.log(elementId);
        domain = window.location.origin
        path_name = '/buy/api/v1/customer/order/add/' //change-this url
        $.ajax({
          type: 'POST',
          url: domain+path_name,
          data: {
              "csrfmiddlewaretoken":g_csrftoken,
              "product" : elementId.toString(),
              "quantity": "1"
          },
            success: function(response) {
                if (response){
                  //console.log(response);
                  document.getElementById("cart-amount").innerHTML = "₹"+response['amount'];
                  document.getElementById("quantity").innerHTML = response['qty'];
                  document.getElementById(elementId+"-qunt_val-category").innerHTML = response['item_qty'];
                  }
                }
              })
            });
      $('.minus-bttn').click(function(e){
        e.preventDefault();
        //fieldName = $(this).attr('field');
        const elementId = $(this).attr('id').split('-')[0]
        //console.log(elementId);
        domain = window.location.origin
        path_name = '/buy/api/v1/customer/order/remove/' //change-this url
        $.ajax({
            type: 'POST',
            url: domain+path_name,
            data: {
                "csrfmiddlewaretoken":g_csrftoken,
                "product" : elementId.toString(),
                "quantity": "1"
            },
            success: function(response) {
                if (response){
                  //console.log(response);
                  document.getElementById("cart-amount").innerHTML = "₹"+response['amount'];
                  document.getElementById("quantity").innerHTML = response['qty'];
                  document.getElementById(elementId+"-qunt_val-category").innerHTML = response['item_qty'];
                  if (response['item_qty'] == 0){
                        $("#"+elementId+"-in-dec-category").hide();
                        //$("#"+elementId+"-add_item:"+cate).show();
                        $('.b-'+elementId).show();
                        $('.fix-in-area').show()
                    }
                  }
                }
              })
                });
  
              });

              function plusBtnClick(element_id,cat_name){
                text = parseInt($("#"+element_id+"-qunt_val-"+cat_name).text())
                val = text + 1
                if (val > 0){
                  $("#"+element_id+"-qunt_val-"+cat_name).empty(val)
                  $("#"+element_id+"-qunt_val-"+cat_name).append(val)
                }
                
              }
              function minusBtnClick(element_id,cat_name){
                text = parseInt($("#"+element_id+"-qunt_val-"+cat_name).text())
                val = text - 1
                if (val > 0){
                  $("#"+element_id+"-qunt_val-"+cat_name).empty(val)
                  $("#"+element_id+"-qunt_val-"+cat_name).append(val)
                }
                else if(val == 0){
                  $("#"+element_id+"-in-dec-"+cat_name).hide()
                  $("#"+element_id+"-add_item:"+cat_name).show()
                  $('.fix-in-area').hide()

                }
              }
    function get_otp(elm){
    input = $('#'+elm).val()
    domain = window.location.origin
    //domain = 'https://ashekhar.pythonanywhere.com'
    path_name = '/api/v1/accounts/register/get_otp/'
    $('#error_login').empty()
    $('#button_submit').attr('disabled')
    $.ajax({
      type: 'POST',
      url: domain+path_name,
      data: {
          "csrfmiddlewaretoken": g_csrftoken,
          "country_code" : "+91",
          "phone_number" : input,
          "fake_otp" : "True",
          "otp":"123456",
      },
      success: function(response) {
          if (response['Status'] == "Sent"){
              $('#'+elm).hide()
              $("#hide-num-text").hide()
              $("#hide-91").hide()
              $("#mobile").hide()
              $('#button_submit').hide()
              $("#hide-otp-text").show()
              $("#otp").show()
              $("#button_otp").show()
          }
          else{
              $("#hide-num-text").hide()
              $("#hide-91").hide()
              $("#mobile").hide()
              $('#button_submit').hide()
              $("#hide-otp-text").show()
              $("#otp").show()
              $("#button_otp").show()
              $('#error_login').css("color","red").text("Limit exceeded").show()
              
          }
      },
      error: function(){
        $("#hide-num-text").show()
        $("#hide-91").show()
        $("#mobile").show()
        $('#button_submit').show()
        $("#hide-otp-text").hide()
        $("#otp").hide()
        $("#button_otp").hide()
      }
    });
    }

    function verify_otp(input_id){
    console.log("verify otp call")
    input  = $('#'+input_id).val()
    phone_number = $('#mobile').val()
    if (input.length == 6){
        $('#error_otp').hide()
        domain = window.location.origin
        //domain = 'https://ashekhar.pythonanywhere.com'
        path_name = '/api/v1/accounts/register/verify/'
        $.ajax({
            type: 'POST',
            url: domain+path_name,
            data: {
                "csrfmiddlewaretoken": g_csrftoken,
                "country_code":"+91",
                "otp" : input,
                "phone_number" : phone_number,
                "web":"True",
            },
            success: function(response) {
                if (response){
                  console.log(response)
                  $('#error_login').empty()
                  $('#error_login').hide()
                  
                  location.reload(true);
                }
                else{
                  $('#error_login').show().append('error') //change this to backend response error.
                }
            }
            
        });
    }
    else if(input.length == 0){
        $('#error_otp').css("color","red").text("enter otp")
    }
    else{
        $('#error_otp').css("color","red").text("Length exceed")
    }
    }
    function hidePopsearch(em_id) {
          $('#' + em_id).hide()
          $('body').css({ "overflow": "auto" })
        }
      function showGreenButton(butn, el,len) {
        value = $(el).val()
        if (value.length == len) {
          $('#' + butn).removeAttr("disabled")
          $('#' + butn).attr("type", "submit")
          $('#' + butn).css({ "background-color": "green", "transition": "0.3s" })
        }
        else {
          $('#' + butn).css({ "background-color": "#ccc", "transition": "0.3s" })
          $('#' + butn).attr("disabled")
          $('#' + butn).attr("type", "button")
        }
      }
    const g_csrftoken = getCookie('csrftoken');
    function showPopsearch(em_id) {
      $('#' + em_id).show()
      valu = $('#location-text').text()
      $('#user_input_autocomplete_address').val(valu)
      $('body').css({ "overflow": "hidden" })
      }
      function showProducts(value){
      //var g_csrftoken_p = getCookie('csrftoken')//
      //var csrftoken = Cookies.get('csrftoken');
      console.log(value)
      domain = window.location.origin
      path_name = '/api/v1/stores/products/' //change-this url
      if(value.length < 3){
        $('.suggestProduct').empty()
        $('.suggestProduct').hide()
      }
      else{
        $.ajax({
            type: 'GET',
            url: domain+path_name,
            data: {
                "csrfmiddlewaretoken":g_csrftoken,
                "products" : value,
                
            },
            success: function(response) {
                if (response){
                  console.log(response)
                  $('.suggestProduct').empty()
                  
                  if (response.length > 0){
                    $('.suggestProduct').show()
                    $.each(response,function(index, item){
                      //console.log(response[index].products.product_id)
                      $('.suggestProduct').append(`
                      <div class="suggest-product d-flex col-12" onclick='window.location.href="/productdetail/`+response[index].products.product_id+`"' >
                        <div class="col-2 ">
                          <img src="https://ashekhar.pythonanywhere.com`+response[index].products.prod_mainimage+`" alt=""  >
                        </div>
                        <div class="product_name col-8 align-self-center">
                          <p>`+response[index].products.product_name+`</p>
                        </div>
                        <div class="align-self-center">
                          <div class="product_pirce "><span class="pro_mrp">`+response[index].products.max_retail_price+`</span><span class="pro_sell">`+response[index].products.max_retail_price+`</span></div>
                          <!-- <a href="#" class="btn btn-style1 btn-padding">ADD</a> -->
                        </div>
                      </div>
                      `)
                    })
                  }
                }
                else{
                  $('.suggestProduct').empty()
                  $('.suggestProduct').show()
                  $('.suggestProduct').append(`
                  <p style="color: red;">Sorry! we regret but we don't have that product, that you search for.</p>
                  `)
                }
            }
            
        });
      }
    }
  </script>
  
</body>

</html>